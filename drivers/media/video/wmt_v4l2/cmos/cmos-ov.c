/**************************************************************		
Some descriptions of such software. Copyright (c) 2008  WonderMedia Technologies, Inc.	
This program is free software: you can redistribute it and/or modify it under the terms 	
of the GNU General Public License as published by the Free Software Foundation, either
 	version 2 of the License, or (at your option) any later version.
	
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
 PURPOSE.  See the GNU General Public License for more details. You should have received
 a copy of the GNU General Public License along with this program.  If not, see
 <http://www.gnu.org/licenses/>.

WonderMedia Technologies, Inc.

--*/

#define CMOS_OV_C

/*--- cmos-ov.c ---------------------------------------------------------------
*
* MODULE       : cmos-ov.c
* AUTHOR       : Willy Chuang
* DATE         : 2010/05/28
* DESCRIPTION  : 
*-----------------------------------------------------------------------------*/

/*--- History ------------------------------------------------------------------- 
*Version 0.01 , Willy Chuang, 2010/05/28
*	First version
*
*------------------------------------------------------------------------------*/

#include <linux/module.h>
#include "../wmt-vid.h"
#include "cmos-ov.h"

#define CMOS_OV7670_I2C_ADDR     0x21


unsigned char ov7670_640_480[]={
0x12,0x80,0x12,0x80,0x11,0x01,0x3A,0x04,0x12,0x00,0x17,0x13,0x18,0x01,0x32,0xB6,
0x19,0x02,0x1A,0x7A,0x03,0x0A,0x0C,0x00,0x3E,0x00,0x70,0x3A,0x71,0x35,0x72,0x11,
0x73,0xF0,0xA2,0x02,0x7A,0x20,0x7B,0x1C,0x7C,0x28,0x7D,0x3C,0x7E,0x5A,0x7F,0x68,
0x80,0x76,0x81,0x80,0x82,0x88,0x83,0x8F,0x84,0x96,0x85,0xA3,0x86,0xAF,0x87,0xC4,
0x88,0xD7,0x89,0xE8,0x13,0xE0,0x00,0x00,0x10,0x00,0x0D,0x40,0x14,0x38,0xA5,0x05,
0xAB,0x07,0x24,0x95,0x25,0x33,0x26,0xE3,0x9F,0x78,0xA0,0x68,0xA1,0x0B,0xA6,0xD8,
0xA7,0xD8,0xA8,0xF0,0xA9,0x90,0xAA,0x94,0x13,0xE5,0x0E,0x61,0x0F,0x4B,0x16,0x02,
0x1E,0x07,0x21,0x02,0x22,0x91,0x29,0x07,0x33,0x0B,0x35,0x0B,0x37,0x1D,0x38,0x71,
0x39,0x2A,0x3C,0x78,0x4D,0x40,0x4E,0x20,0x69,0x00,0x6B,0x4A,0x74,0x10,0x8D,0x4F,
0x8E,0x00,0x8F,0x00,0x90,0x00,0x91,0x00,0x96,0x00,0x9A,0x80,0xB0,0x84,0xB1,0x0C,
0xB2,0x0E,0xB3,0x82,0xB8,0x0A,0x43,0x14,0x44,0xF0,0x45,0x34,0x46,0x58,0x47,0x28,
0x48,0x3A,0x59,0x88,0x5A,0x88,0x5B,0x44,0x5C,0x67,0x5D,0x49,0x5E,0x0E,0x6C,0x0A,
0x6D,0x55,0x6E,0x11,0x6F,0x9F,0x6A,0x40,0x01,0x40,0x02,0x40,0x13,0xE7,0x4F,0x80,
0x50,0x80,0x51,0x00,0x52,0x22,0x53,0x5E,0x54,0x80,0x58,0x9E,0x41,0x08,0x3F,0x00,
0x75,0x04,0x76,0xE1,0x4C,0x00,0x77,0x01,0x3D,0xC2,0x4B,0x09,0xC9,0x60,0x41,0x38,
0x56,0x40,0x34,0x11,0x3B,0x02,0xA4,0x88,0x96,0x00,0x97,0x30,0x98,0x20,0x99,0x30,
0x9A,0x84,0x9B,0x29,0x9C,0x03,0x9D,0x4C,0x9E,0x3F,0x78,0x04,0x79,0x01,0xC8,0xF0,
0x79,0x0F,0xC8,0x00,0x79,0x10,0xC8,0x7E,0x79,0x0A,0xC8,0x80,0x79,0x0B,0xC8,0x01,
0x79,0x0C,0xC8,0x0F,0x79,0x0D,0xC8,0x20,0x79,0x09,0xC8,0x80,0x79,0x02,0xC8,0xC0,
0x79,0x03,0xC8,0x40,0x79,0x05,0xC8,0x30,0x79,0x26,0x12,0x80,0x11,0x01,0x3A,0x04,
0x12,0x00,0x17,0x13,0x18,0x01,0x32,0xB6,0x19,0x02,0x1A,0x7A,0x03,0x0A,0x0C,0x00,
0x3E,0x00,0x70,0x3A,0x71,0x35,0x72,0x11,0x73,0xF0,0xA2,0x02,0x7A,0x20,0x7B,0x1C,
0x7C,0x28,0x7D,0x3C,0x7E,0x5A,0x7F,0x68,0x80,0x76,0x81,0x80,0x82,0x88,0x83,0x8F,
0x84,0x96,0x85,0xA3,0x86,0xAF,0x87,0xC4,0x88,0xD7,0x89,0xE8,0x13,0xE0,0x00,0x00,
0x10,0x00,0x0D,0x40,0x14,0x38,0xA5,0x05,0xAB,0x07,0x24,0x95,0x25,0x33,0x26,0xE3,
0x9F,0x78,0xA0,0x68,0xA1,0x0B,0xA6,0xD8,0xA7,0xD8,0xA8,0xF0,0xA9,0x90,0xAA,0x94,
0x13,0xE5,0x0E,0x61,0x0F,0x4B,0x16,0x02,0x1E,0x07,0x21,0x02,0x22,0x91,0x29,0x07,
0x33,0x0B,0x35,0x0B,0x37,0x1D,0x38,0x71,0x39,0x2A,0x3C,0x78,0x4D,0x40,0x4E,0x20,
0x69,0x00,0x6B,0x4A,0x74,0x10,0x8D,0x4F,0x8E,0x00,0x8F,0x00,0x90,0x00,0x91,0x00,
0x96,0x00,0x9A,0x80,0xB0,0x84,0xB1,0x0C,0xB2,0x0E,0xB3,0x82,0xB8,0x0A,0x43,0x14,
0x44,0xF0,0x45,0x34,0x46,0x58,0x47,0x28,0x48,0x3A,0x59,0x88,0x5A,0x88,0x5B,0x44,
0x5C,0x67,0x5D,0x49,0x5E,0x0E,0x6C,0x0A,0x6D,0x55,0x6E,0x11,0x6F,0x9F,0x6A,0x40,
0x01,0x40,0x02,0x40,0x13,0xE7,0x4F,0x80,0x50,0x80,0x51,0x00,0x52,0x22,0x53,0x5E,
0x54,0x80,0x58,0x9E,0x41,0x08,0x3F,0x00,0x75,0x04,0x76,0xE1,0x4C,0x00,0x77,0x01,
0x3D,0xC2,0x4B,0x09,0xC9,0x60,0x41,0x38,0x56,0x40,0x34,0x11,0x3B,0x02,0xA4,0x88,
0x96,0x00,0x97,0x30,0x98,0x20,0x99,0x30,0x9A,0x84,0x9B,0x29,0x9C,0x03,0x9D,0x4C,
0x9E,0x3F,0x78,0x04,0x79,0x01,0xC8,0xF0,0x79,0x0F,0xC8,0x00,0x79,0x10,0xC8,0x7E,
0x79,0x0A,0xC8,0x80,0x79,0x0B,0xC8,0x01,0x79,0x0C,0xC8,0x0F,0x79,0x0D,0xC8,0x20,
0x79,0x09,0xC8,0x80,0x79,0x02,0xC8,0xC0,0x79,0x03,0xC8,0x40,0x79,0x05,0xC8,0x30,
0x79,0x26,0x12,0x80,0x11,0x01,0x3A,0x04,0x12,0x00,0x17,0x13,0x18,0x01,0x32,0xB6,
0x19,0x02,0x1A,0x7A,0x03,0x0A,0x0C,0x00,0x3E,0x00,0x70,0x3A,0x71,0x35,0x72,0x11,
0x73,0xF0,0xA2,0x02,0x7A,0x20,0x7B,0x1C,0x7C,0x28,0x7D,0x3C,0x7E,0x5A,0x7F,0x68,
0x80,0x76,0x81,0x80,0x82,0x88,0x83,0x8F,0x84,0x96,0x85,0xA3,0x86,0xAF,0x87,0xC4,
0x88,0xD7,0x89,0xE8,0x13,0xE0,0x00,0x00,0x10,0x00,0x0D,0x40,0x14,0x38,0xA5,0x05,
0xAB,0x07,0x24,0x95,0x25,0x33,0x26,0xE3,0x9F,0x78,0xA0,0x68,0xA1,0x0B,0xA6,0xD8,
0xA7,0xD8,0xA8,0xF0,0xA9,0x90,0xAA,0x94,0x13,0xE5,0x0E,0x61,0x0F,0x4B,0x16,0x02,
0x1E,0x07,0x21,0x02,0x22,0x91,0x29,0x07,0x33,0x0B,0x35,0x0B,0x37,0x1D,0x38,0x71,
0x39,0x2A,0x3C,0x78,0x4D,0x40,0x4E,0x20,0x69,0x00,0x6B,0x4A,0x74,0x10,0x8D,0x4F,
0x8E,0x00,0x8F,0x00,0x90,0x00,0x91,0x00,0x96,0x00,0x9A,0x80,0xB0,0x84,0xB1,0x0C,
0xB2,0x0E,0xB3,0x82,0xB8,0x0A,0x43,0x14,0x44,0xF0,0x45,0x34,0x46,0x58,0x47,0x28,
0x48,0x3A,0x59,0x88,0x5A,0x88,0x5B,0x44,0x5C,0x67,0x5D,0x49,0x5E,0x0E,0x6C,0x0A,
0x6D,0x55,0x6E,0x11,0x6F,0x9F,0x6A,0x40,0x01,0x40,0x02,0x40,0x13,0xE7,0x4F,0x80,
0x50,0x80,0x51,0x00,0x52,0x22,0x53,0x5E,0x54,0x80,0x58,0x9E,0x41,0x08,0x3F,0x00,
0x75,0x04,0x76,0xE1,0x4C,0x00,0x77,0x01,0x3D,0xC2,0x4B,0x09,0xC9,0x60,0x41,0x38,
0x56,0x40,0x34,0x11,0x3B,0x02,0xA4,0x88,0x96,0x00,0x97,0x30,0x98,0x20,0x99,0x30,
0x9A,0x84,0x9B,0x29,0x9C,0x03,0x9D,0x4C,0x9E,0x3F,0x78,0x04,0x79,0x01,0xC8,0xF0,
0x79,0x0F,0xC8,0x00,0x79,0x10,0xC8,0x7E,0x79,0x0A,0xC8,0x80,0x79,0x0B,0xC8,0x01,
0x79,0x0C,0xC8,0x0F,0x79,0x0D,0xC8,0x20,0x79,0x09,0xC8,0x80,0x79,0x02,0xC8,0xC0,
0x79,0x03,0xC8,0x40,0x79,0x05,0xC8,0x30,0x79,0x26,0x02,0x86,0x2B,0x00,0x18,0x01,
0x00,0x00,0x01,0x90,
};

int ov7670_exist()
{
	
	int ret1, ret2;
	ret1 = wmt_vid_i2c_read(CMOS_OV7670_I2C_ADDR, 0xa);
	ret2 = wmt_vid_i2c_read(CMOS_OV7670_I2C_ADDR, 0xb);
	printk("the ID of device in I2C addr %x is %x, %x\n", 
			CMOS_OV7670_I2C_ADDR,
			ret1, 
			ret2);
	if ((ret1==0x76) && (ret2==0x73)){
		return true;
	}else{
		 return false;
	}
	
}

int cmos_init_ov7670(int width, int height)
{
    char *array_addr;
    char  addr,data;
    int   array_size, i;

	/*
	int ret1, ret2;
	ret1 = wmt_vid_i2c_read(CMOS_OV7670_I2C_ADDR, 0xa);
	ret2 = wmt_vid_i2c_read(CMOS_OV7670_I2C_ADDR, 0xb);
	printk("the ID of ov7670 is %x, %x\n", ret1, ret2);
	char ret_data;
	*/

    if( (width == 640) && (height == 480) ) {
        array_size = sizeof(ov7670_640_480);
        array_addr = ov7670_640_480;
    }
    else {
        /* Not-supported Resolution */
        return -1;
    }

    for (i = 0; i <array_size ; i+=2){
        addr = array_addr[i];
        data = array_addr[i+1];

        wmt_vid_i2c_write( CMOS_OV7670_I2C_ADDR, addr, data);
		/*
		ret_data = wmt_vid_i2c_read(CMOS_OV7670_I2C_ADDR, addr);
		if (data != ret_data){
			printk("addr %x : write %x, read %x\n",
						addr, data, ret_data);		
		}
		*/
    }    
    return 0;
} /* End of cmos_init_ov7670() */

int cmos_exit_ov7670(int width, int height)
{
    return 0;
} /* End of cmos_exit_ov7670() */

/*------------------------------------------------------------------------------*/
/*--------------------End of Function Body -----------------------------------*/

#undef CMOS_OV_C
